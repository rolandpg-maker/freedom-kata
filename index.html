<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KATA Improvement Tracker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #f5f5f5; 
            min-height: 100vh; 
        }
        
        /* Header */
        .header { 
            background: white; 
            border-bottom: 1px solid #e0e0e0; 
            padding: 20px 40px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .logo { 
            width: 50px; 
            height: 50px; 
            border-radius: 50%;
        }
        .header-title { display: flex; align-items: center; gap: 15px; }
        .header-title h1 { color: #333; font-size: 1.5em; margin-bottom: 2px; }
        .header-title p { color: #666; font-size: 0.9em; }
        
        /* Info Icon */
        .info-icon {
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e84142;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            transition: background 0.3s;
            flex-shrink: 0;
        }
        .info-icon:hover {
            background: #c23334;
        }
        
        /* Container */
        .container { max-width: 1400px; margin: 0 auto; padding: 30px 40px; }
        
        /* Filters */
        .filters { display: flex; gap: 15px; margin-bottom: 30px; }
        select { 
            padding: 10px 15px; 
            border-radius: 8px; 
            border: 1px solid #e0e0e0; 
            font-size: 14px; 
            background: white; 
            cursor: pointer; 
        }
        
        /* Buttons */
        .btn { 
            padding: 10px 20px; 
            border-radius: 8px; 
            border: none; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: 600; 
            transition: all 0.3s; 
        }
        .btn-primary { background: #e84142; color: white; }
        .btn-primary:hover { background: #c23334; }
        .btn-secondary { background: white; color: #333; border: 1px solid #e0e0e0; }
        .btn-secondary:hover { background: #f5f5f5; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-danger:hover { background: #b91c1c; }
        .btn-icon { padding: 8px 12px; font-size: 0.9em; }
        
        /* Projects Grid */
        .projects-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); 
            gap: 20px; 
        }
        .project-card { 
            background: white; 
            border-radius: 12px; 
            padding: 20px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); 
            cursor: pointer; 
            transition: all 0.3s; 
        }
        .project-card:hover { 
            box-shadow: 0 4px 12px rgba(0,0,0,0.12); 
            transform: translateY(-2px); 
        }
        
        /* Status Badges */
        .status-badge { 
            padding: 4px 12px; 
            border-radius: 20px; 
            font-size: 0.75em; 
            font-weight: 600; 
        }
        .status-active { background: #d4f4dd; color: #0f7b2e; }
        .status-on-hold { background: #fff4cc; color: #a87000; }
        .status-completed { background: #e0e0e0; color: #666; }
        
        /* Project Card Content */
        .project-title { font-size: 1.1em; font-weight: 700; color: #333; margin: 10px 0; }
        .project-description { 
            color: #666; 
            font-size: 0.9em; 
            margin-bottom: 15px; 
            line-height: 1.5; 
            display: -webkit-box; 
            -webkit-line-clamp: 2; 
            -webkit-box-orient: vertical; 
            overflow: hidden; 
        }
        .project-meta { display: flex; flex-direction: column; gap: 8px; font-size: 0.85em; color: #666; }
        .cycle-count { color: #e84142; font-weight: 600; }
        
        /* Detail View */
        .detail-view { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: #f5f5f5; 
            z-index: 1000; 
            overflow-y: auto; 
        }
        .detail-view.active { display: block; }
        .detail-header { 
            background: white; 
            border-bottom: 1px solid #e0e0e0; 
            padding: 20px 40px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .detail-content { max-width: 1200px; margin: 0 auto; padding: 30px 40px; }
        .project-actions { display: flex; gap: 10px; }
        
        /* Project Info */
        .project-info { background: white; border-radius: 12px; padding: 30px; margin-bottom: 30px; }
        .project-info-title { font-size: 1.8em; font-weight: 700; color: #333; }
        .project-info-grid { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 30px; margin-top: 20px; }
        .info-section h3 { font-size: 0.9em; color: #666; margin-bottom: 8px; font-weight: 600; }
        
        /* Cycles */
        .cycles-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
        }
        .cycle-card { 
            background: white; 
            border-radius: 12px; 
            padding: 25px; 
            margin-bottom: 20px; 
            position: relative; 
        }
        .cycle-card-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            padding-bottom: 15px; 
            border-bottom: 2px solid #f5f5f5; 
        }
        .cycle-title { font-size: 1.3em; font-weight: 700; color: #333; }
        .cycle-actions { display: flex; gap: 10px; }
        
        /* KATA Components */
        .kata-component { 
            margin-bottom: 20px; 
            border-radius: 10px; 
            padding: 15px; 
            border-left: 4px solid; 
        }
        .kata-component.actual { background: #fef2f2; border-color: #ef4444; }
        .kata-component.target { background: #eff6ff; border-color: #3b82f6; }
        .kata-component.obstacle { background: #fef9e7; border-color: #f59e0b; }
        .kata-component.nextstep { background: #f3e8ff; border-color: #a855f7; }
        .kata-component.learning { background: #ecfdf5; border-color: #10b981; }
        
        .kata-component-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .kata-icon { 
            width: 32px; 
            height: 32px; 
            border-radius: 8px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 16px; 
        }
        .kata-component.actual .kata-icon { background: #ef4444; color: white; }
        .kata-component.target .kata-icon { background: #3b82f6; color: white; }
        .kata-component.obstacle .kata-icon { background: #f59e0b; color: white; }
        .kata-component.nextstep .kata-icon { background: #a855f7; color: white; }
        .kata-component.learning .kata-icon { background: #10b981; color: white; }
        
        .kata-component-title { font-weight: 700; color: #333; }
        .kata-component-content { color: #555; line-height: 1.6; margin-left: 42px; white-space: pre-wrap; }
        
        /* Due Date - UPDATED */
        .due-date-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            margin-left: 42px;
        }
        .due-date-label {
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
        }
        .deadline-badge { 
            display: inline-block; 
            padding: 4px 12px; 
            border-radius: 20px; 
            font-size: 0.85em; 
            font-weight: 600; 
        }
        .deadline-badge.overdue { background: #fee; color: #c00; }
        .deadline-badge.upcoming { background: #fff4cc; color: #a87000; }
        .deadline-badge.ok { background: #d4f4dd; color: #0f7b2e; }
        
        /* Modal */
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0,0,0,0.5); 
            z-index: 2000; 
            align-items: center; 
            justify-content: center; 
        }
        .modal.active { display: flex; }
        .modal-content { 
            background: white; 
            border-radius: 12px; 
            width: 90%; 
            max-width: 600px; 
            max-height: 90vh; 
            overflow-y: auto; 
            padding: 30px; 
        }
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 25px; 
        }
        .modal-title { font-size: 1.5em; font-weight: 700; color: #333; }
        .close-btn { 
            background: none; 
            border: none; 
            font-size: 24px; 
            cursor: pointer; 
            color: #999; 
            padding: 0; 
            width: 30px; 
            height: 30px; 
        }
        
        /* Form */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: #333; }
        .form-group input, 
        .form-group select, 
        .form-group textarea { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #e0e0e0; 
            border-radius: 8px; 
            font-size: 14px; 
            font-family: inherit; 
        }
        .form-group textarea { min-height: 80px; resize: vertical; }
        .form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px; }
        
        /* Info Modal */
        .info-modal-content {
            max-width: 700px;
        }
        .info-text {
            color: #555;
            line-height: 1.8;
            font-size: 1.05em;
            margin-bottom: 20px;
        }
        
        /* Empty State */
        .empty-state { text-align: center; padding: 60px 20px; background: white; border-radius: 12px; }
        .empty-state h3 { font-size: 1.3em; color: #333; margin-bottom: 10px; }
        .empty-state p { color: #666; }
        
        /* Loading */
        .loading { text-align: center; padding: 40px; color: #666; }
        
        /* Setup Banner */
        .setup-banner {
            background: #fff4cc;
            border: 2px solid #f59e0b;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 40px;
            text-align: center;
        }
        .setup-banner h2 {
            color: #a87000;
            margin-bottom: 10px;
        }
        .setup-banner p {
            color: #666;
            margin-bottom: 15px;
        }
        .setup-banner code {
            background: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            color: #333;
        }
        
        /* Hidden */
        .hidden { display: none; }
    </style>
</head>
<body>
    <!-- Setup Banner (shown when Firebase not configured) -->
    <div id="setupBanner" class="setup-banner" style="display: none;">
        <h2>‚ö†Ô∏è Firebase Configuration Required</h2>
        <p>Please update the Firebase configuration in the HTML file to enable the shared database.</p>
        <p>Look for the <code>firebaseConfig</code> section in the code and replace it with your Firebase project details.</p>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <img src="Freedom-Round-Red.png" alt="Freedom Logo" class="logo">
            <div class="header-title">
                <div>
                    <h1>KATA Improvement Tracker</h1>
                    <p>Continuous improvement through structured experiments</p>
                </div>
                <div class="info-icon" onclick="openInfoModal()">i</div>
            </div>
        </div>
        <button class="btn btn-primary" onclick="openProjectModal()">+ New Project</button>
    </div>

    <!-- Main Container -->
    <div class="container">
        <div class="filters">
            <select id="statusFilter">
                <option value="all">All Status</option>
                <option value="active">Active</option>
                <option value="on-hold">On Hold</option>
                <option value="completed">Completed</option>
            </select>
            <select id="ownerFilter">
                <option value="all">All Owners</option>
                <option value="Roland">Roland</option>
                <option value="Rosie">Rosie</option>
                <option value="Karl">Karl</option>
                <option value="Reece">Reece</option>
                <option value="Harry">Harry</option>
            </select>
        </div>

        <div id="projectsContainer">
            <div class="loading">Loading projects...</div>
        </div>
    </div>

    <!-- Detail View -->
    <div id="detailView" class="detail-view">
        <div class="detail-header">
            <button class="btn btn-secondary" onclick="closeDetailView()">‚Üê Back to Projects</button>
            <div class="project-actions">
                <button class="btn btn-secondary" onclick="editCurrentProject()">Edit Project</button>
                <button class="btn btn-danger" onclick="deleteCurrentProject()">Delete Project</button>
            </div>
        </div>
        <div class="detail-content">
            <div class="project-info">
                <div class="project-info-title" id="detailTitle"></div>
                <div class="project-info-grid">
                    <div class="info-section">
                        <h3>DESCRIPTION</h3>
                        <p id="detailDescription"></p>
                    </div>
                    <div class="info-section">
                        <h3>OWNER</h3>
                        <p id="detailOwner"></p>
                    </div>
                    <div class="info-section">
                        <h3>START DATE</h3>
                        <p id="detailStartDate"></p>
                    </div>
                </div>
            </div>

            <div class="cycles-header">
                <h2>KATA Cycles</h2>
                <button class="btn btn-primary" onclick="openCycleModal()">+ Add New Cycle</button>
            </div>
            <div id="cyclesContainer"></div>
        </div>
    </div>

    <!-- Project Modal -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="projectModalTitle">Create New Project</h2>
                <button class="close-btn" onclick="closeProjectModal()">√ó</button>
            </div>
            <form id="projectForm">
                <div class="form-group">
                    <label for="projectTitle">Project Title *</label>
                    <input type="text" id="projectTitle" required>
                </div>
                <div class="form-group">
                    <label for="projectDescription">Description *</label>
                    <textarea id="projectDescription" required></textarea>
                </div>
                <div class="form-group">
                    <label for="projectOwner">Owner *</label>
                    <select id="projectOwner" required>
                        <option value="">Select owner...</option>
                        <option value="Roland">Roland</option>
                        <option value="Rosie">Rosie</option>
                        <option value="Karl">Karl</option>
                        <option value="Reece">Reece</option>
                        <option value="Harry">Harry</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="projectStatus">Status *</label>
                    <select id="projectStatus" required>
                        <option value="active">Active</option>
                        <option value="on-hold">On Hold</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="projectStartDate">Start Date *</label>
                    <input type="date" id="projectStartDate" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeProjectModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Project</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Cycle Modal -->
    <div id="cycleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="cycleModalTitle">Add New KATA Cycle</h2>
                <button class="close-btn" onclick="closeCycleModal()">√ó</button>
            </div>
            <form id="cycleForm">
                <div class="form-group">
                    <label for="actualCondition">Actual Condition *</label>
                    <textarea id="actualCondition" required placeholder="What is the current state?"></textarea>
                </div>
                <div class="form-group">
                    <label for="targetCondition">Target Condition *</label>
                    <textarea id="targetCondition" required placeholder="What is the desired state?"></textarea>
                </div>
                <div class="form-group">
                    <label for="obstacles">Obstacles</label>
                    <textarea id="obstacles" placeholder="What obstacles are preventing progress?"></textarea>
                </div>
                <div class="form-group">
                    <label for="nextSteps">Next Steps *</label>
                    <textarea id="nextSteps" required placeholder="What experiments will you run?"></textarea>
                </div>
                <div class="form-group">
                    <label for="deadline">Deadline</label>
                    <input type="date" id="deadline">
                </div>
                <div class="form-group">
                    <label for="learnings">Learnings</label>
                    <textarea id="learnings" placeholder="What have you learned from this cycle?"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeCycleModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Cycle</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="infoModal" class="modal">
        <div class="modal-content info-modal-content">
            <div class="modal-header">
                <h2 class="modal-title">What is KATA?</h2>
                <button class="close-btn" onclick="closeInfoModal()">√ó</button>
            </div>
            <div class="info-text">
                <p>KATA is a structured, continuous improvement routine that helps teams build problem-solving habits and achieve ambitious goals through small, consistent steps. Originating from Toyota's improvement and coaching practices, it focuses on understanding the current condition, setting a clear target, experimenting toward it, and learning from each step.</p>
                <p style="margin-top: 15px;">By applying KATA in our travel insurance business, we create a culture of curiosity, accountability, and innovation. It enables everyone, from contact centre to management, to identify barriers, test ideas quickly, and measure progress scientifically. The result is smarter decisions, better customer experiences, and steady growth through daily, purposeful improvement.</p>
            </div>
            <div class="form-actions">
                <button class="btn btn-primary" onclick="closeInfoModal()">Got it!</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // Replace this with your Firebase project config
        // ============================================
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY_HERE",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Check if Firebase is configured
        const isConfigured = firebaseConfig.apiKey !== "YOUR_API_KEY_HERE";
        
        if (!isConfigured) {
            document.getElementById('setupBanner').style.display = 'block';
        }

        // Initialize Firebase
        let db;
        if (isConfigured) {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
        }

        // Global variables
        let projects = [];
        let currentProjectId = null;
        let editingProjectId = null;
        let editingCycleId = null;

        // Database functions
        async function loadProjects() {
            if (!isConfigured) {
                // Use localStorage as fallback
                try {
                    const stored = localStorage.getItem('kata-projects');
                    if (stored) {
                        projects = JSON.parse(stored);
                    }
                } catch (error) {
                    console.error('Failed to load from localStorage:', error);
                }
                renderProjects();
                return;
            }

            try {
                const snapshot = await db.ref('projects').once('value');
                const data = snapshot.val();
                projects = data ? Object.values(data) : [];
                renderProjects();
            } catch (error) {
                console.error('Failed to load projects:', error);
                alert('Failed to load projects. Please refresh the page.');
            }
        }

        async function saveProject(project) {
            if (!isConfigured) {
                // Use localStorage as fallback
                const index = projects.findIndex(p => p.id === project.id);
                if (index >= 0) {
                    projects[index] = project;
                } else {
                    projects.push(project);
                }
                localStorage.setItem('kata-projects', JSON.stringify(projects));
                return true;
            }

            try {
                await db.ref('projects/' + project.id).set(project);
                return true;
            } catch (error) {
                console.error('Failed to save project:', error);
                alert('Failed to save project. Please try again.');
                return false;
            }
        }

        async function deleteProjectFromDB(projectId) {
            if (!isConfigured) {
                // Use localStorage as fallback
                projects = projects.filter(p => p.id !== projectId);
                localStorage.setItem('kata-projects', JSON.stringify(projects));
                return true;
            }

            try {
                await db.ref('projects/' + projectId).remove();
                return true;
            } catch (error) {
                console.error('Failed to delete project:', error);
                alert('Failed to delete project. Please try again.');
                return false;
            }
        }

        // Initialize app
        function init() {
            loadProjects();
            setupEventListeners();
            
            // Listen for real-time updates if Firebase is configured
            if (isConfigured) {
                db.ref('projects').on('value', (snapshot) => {
                    const data = snapshot.val();
                    projects = data ? Object.values(data) : [];
                    renderProjects();
                    
                    // Update detail view if currently viewing a project
                    if (currentProjectId) {
                        const currentProject = projects.find(p => p.id === currentProjectId);
                        if (currentProject) {
                            renderCycles(currentProject);
                        }
                    }
                });
            }
        }

        function setupEventListeners() {
            document.getElementById('statusFilter').onchange = renderProjects;
            document.getElementById('ownerFilter').onchange = renderProjects;

            document.getElementById('projectForm').onsubmit = (e) => {
                e.preventDefault();
                handleProjectSubmit();
            };

            document.getElementById('cycleForm').onsubmit = (e) => {
                e.preventDefault();
                handleCycleSubmit();
            };
        }

        // Project form handling
        async function handleProjectSubmit() {
            const projectData = {
                title: document.getElementById('projectTitle').value,
                description: document.getElementById('projectDescription').value,
                owner: document.getElementById('projectOwner').value,
                status: document.getElementById('projectStatus').value,
                startDate: document.getElementById('projectStartDate').value
            };

            let project;
            if (editingProjectId) {
                // Update existing project
                project = projects.find(p => p.id === editingProjectId);
                if (project) {
                    Object.assign(project, projectData);
                    project.updatedAt = new Date().toISOString();
                }
            } else {
                // Create new project
                project = {
                    id: 'proj_' + Date.now(),
                    ...projectData,
                    cycles: [],
                    createdAt: new Date().toISOString()
                };
            }

            if (await saveProject(project)) {
                closeProjectModal();
                await loadProjects();
                if (currentProjectId === editingProjectId) {
                    showProjectDetail(editingProjectId);
                }
            }
        }

        // Cycle form handling
        async function handleCycleSubmit() {
            const project = projects.find(p => p.id === currentProjectId);
            if (!project) return;

            const cycleData = {
                actualCondition: document.getElementById('actualCondition').value,
                targetCondition: document.getElementById('targetCondition').value,
                obstacles: document.getElementById('obstacles').value,
                nextSteps: document.getElementById('nextSteps').value,
                deadline: document.getElementById('deadline').value,
                learnings: document.getElementById('learnings').value
            };

            if (editingCycleId) {
                // Update existing cycle
                const cycle = project.cycles.find(c => c.id === editingCycleId);
                if (cycle) {
                    Object.assign(cycle, cycleData);
                    cycle.updatedAt = new Date().toISOString();
                }
            } else {
                // Create new cycle
                const newCycle = {
                    id: 'cycle_' + Date.now(),
                    ...cycleData,
                    createdAt: new Date().toISOString()
                };
                if (!project.cycles) project.cycles = [];
                project.cycles.unshift(newCycle);
            }

            if (await saveProject(project)) {
                closeCycleModal();
                renderCycles(project);
            }
        }

        // Render functions
        function renderProjects() {
            const statusFilter = document.getElementById('statusFilter').value;
            const ownerFilter = document.getElementById('ownerFilter').value;

            let filtered = projects.filter(p => {
                if (statusFilter !== 'all' && p.status !== statusFilter) return false;
                if (ownerFilter !== 'all' && p.owner !== ownerFilter) return false;
                return true;
            });

            const container = document.getElementById('projectsContainer');

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No projects found</h3>
                        <p>Create your first project to start tracking KATA cycles</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="projects-grid">
                    ${filtered.map(project => `
                        <div class="project-card" onclick="showProjectDetail('${project.id}')">
                            <span class="status-badge status-${project.status}">${formatStatus(project.status)}</span>
                            <div class="project-title">${escapeHtml(project.title)}</div>
                            <div class="project-description">${escapeHtml(project.description)}</div>
                            <div class="project-meta">
                                <div>Owner: <strong>${escapeHtml(project.owner)}</strong></div>
                                <div>Started: ${formatDate(project.startDate)}</div>
                                <div class="cycle-count">${project.cycles?.length || 0} KATA cycles</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderCycles(project) {
            const container = document.getElementById('cyclesContainer');

            if (!project.cycles || project.cycles.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No KATA cycles yet</h3>
                        <p>Add your first cycle to start tracking improvements</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = project.cycles.map(cycle => `
                <div class="cycle-card">
                    <div class="cycle-card-header">
                        <div class="cycle-title">Cycle ${formatDate(cycle.createdAt)}</div>
                        <div class="cycle-actions">
                            <button class="btn btn-secondary btn-icon" onclick="editCycle('${project.id}', '${cycle.id}')">Edit</button>
                            <button class="btn btn-danger btn-icon" onclick="deleteCycle('${project.id}', '${cycle.id}')">Delete</button>
                        </div>
                    </div>

                    <div class="kata-component actual">
                        <div class="kata-component-header">
                            <div class="kata-icon">üìç</div>
                            <div class="kata-component-title">Actual Condition</div>
                        </div>
                        <div class="kata-component-content">${escapeHtml(cycle.actualCondition)}</div>
                    </div>

                    <div class="kata-component target">
                        <div class="kata-component-header">
                            <div class="kata-icon">üéØ</div>
                            <div class="kata-component-title">Target Condition</div>
                        </div>
                        <div class="kata-component-content">${escapeHtml(cycle.targetCondition)}</div>
                    </div>

                    ${cycle.obstacles ? `
                        <div class="kata-component obstacle">
                            <div class="kata-component-header">
                                <div class="kata-icon">‚ö†Ô∏è</div>
                                <div class="kata-component-title">Obstacles</div>
                            </div>
                            <div class="kata-component-content">${escapeHtml(cycle.obstacles)}</div>
                        </div>
                    ` : ''}

                    <div class="kata-component nextstep">
                        <div class="kata-component-header">
                            <div class="kata-icon">‚Üí</div>
                            <div class="kata-component-title">Next Steps</div>
                        </div>
                        <div class="kata-component-content">${escapeHtml(cycle.nextSteps)}</div>
                        ${cycle.deadline ? `
                            <div class="due-date-container">
                                <span class="due-date-label">Due date:</span>
                                <span class="deadline-badge ${getDeadlineClass(cycle.deadline)}">üìÖ ${formatDate(cycle.deadline)}</span>
                            </div>
                        ` : ''}
                    </div>

                    ${cycle.learnings ? `
                        <div class="kata-component learning">
                            <div class="kata-component-header">
                                <div class="kata-icon">üí°</div>
                                <div class="kata-component-title">Learnings</div>
                            </div>
                            <div class="kata-component-content">${escapeHtml(cycle.learnings)}</div>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // Modal functions
        function openProjectModal(projectId = null) {
            editingProjectId = projectId;
            
            if (projectId) {
                const project = projects.find(p => p.id === projectId);
                if (project) {
                    document.getElementById('projectModalTitle').textContent = 'Edit Project';
                    document.getElementById('projectTitle').value = project.title;
                    document.getElementById('projectDescription').value = project.description;
                    document.getElementById('projectOwner').value = project.owner;
                    document.getElementById('projectStatus').value = project.status;
                    document.getElementById('projectStartDate').value = project.startDate;
                }
            } else {
                document.getElementById('projectModalTitle').textContent = 'Create New Project';
                document.getElementById('projectForm').reset();
            }
            
            document.getElementById('projectModal').classList.add('active');
        }

        function closeProjectModal() {
            editingProjectId = null;
            document.getElementById('projectModal').classList.remove('active');
            document.getElementById('projectForm').reset();
        }

        function openCycleModal(cycleId = null) {
            editingCycleId = cycleId;
            
            if (cycleId) {
                const project = projects.find(p => p.id === currentProjectId);
                const cycle = project?.cycles.find(c => c.id === cycleId);
                if (cycle) {
                    document.getElementById('cycleModalTitle').textContent = 'Edit KATA Cycle';
                    document.getElementById('actualCondition').value = cycle.actualCondition;
                    document.getElementById('targetCondition').value = cycle.targetCondition;
                    document.getElementById('obstacles').value = cycle.obstacles || '';
                    document.getElementById('nextSteps').value = cycle.nextSteps;
                    document.getElementById('deadline').value = cycle.deadline || '';
                    document.getElementById('learnings').value = cycle.learnings || '';
                }
            } else {
                document.getElementById('cycleModalTitle').textContent = 'Add New KATA Cycle';
                document.getElementById('cycleForm').reset();
            }
            
            document.getElementById('cycleModal').classList.add('active');
        }

        function closeCycleModal() {
            editingCycleId = null;
            document.getElementById('cycleModal').classList.remove('active');
            document.getElementById('cycleForm').reset();
        }

        // Info Modal functions
        function openInfoModal() {
            document.getElementById('infoModal').classList.add('active');
        }

        function closeInfoModal() {
            document.getElementById('infoModal').classList.remove('active');
        }

        // Detail view functions
        function showProjectDetail(projectId) {
            currentProjectId = projectId;
            const project = projects.find(p => p.id === projectId);
            if (!project) return;

            document.getElementById('detailTitle').textContent = project.title;
            document.getElementById('detailDescription').textContent = project.description;
            document.getElementById('detailOwner').textContent = project.owner;
            document.getElementById('detailStartDate').textContent = formatDate(project.startDate);

            renderCycles(project);
            document.getElementById('detailView').classList.add('active');
        }

        function closeDetailView() {
            currentProjectId = null;
            document.getElementById('detailView').classList.remove('active');
        }

        // Edit functions
        function editCurrentProject() {
            openProjectModal(currentProjectId);
        }

        function editCycle(projectId, cycleId) {
            openCycleModal(cycleId);
        }

        // Delete functions
        async function deleteCurrentProject() {
            if (!confirm('Are you sure you want to delete this project? This action cannot be undone.')) {
                return;
            }

            if (await deleteProjectFromDB(currentProjectId)) {
                closeDetailView();
                await loadProjects();
            }
        }

        async function deleteCycle(projectId, cycleId) {
            if (!confirm('Are you sure you want to delete this cycle?')) {
                return;
            }

            const project = projects.find(p => p.id === projectId);
            if (!project) return;

            const index = project.cycles.findIndex(c => c.id === cycleId);
            if (index !== -1) {
                project.cycles.splice(index, 1);
                if (await saveProject(project)) {
                    renderCycles(project);
                }
            }
        }

        // Utility functions
        function formatDate(dateStr) {
            if (!dateStr) return 'Not set';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        function formatStatus(status) {
            return status.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }

        function getDeadlineClass(deadline) {
            if (!deadline) return '';
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const deadlineDate = new Date(deadline);
            deadlineDate.setHours(0, 0, 0, 0);
            const daysUntil = Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24));

            if (daysUntil < 0) return 'overdue';
            if (daysUntil <= 7) return 'upcoming';
            return 'ok';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize the app when page loads
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
